@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var users = ViewBag.Users as List<LeaveManagementSystem.Models.Entities.User>;
    var departments = ViewBag.Departments as List<LeaveManagementSystem.Models.Entities.Department>;
    var leaves = ViewBag.Leaves as List<LeaveManagementSystem.Models.Entities.LeaveApplication>;

    var approvedCount = leaves.Count(l => l.Status == "Approved");
    var pendingCount = leaves.Count(l => l.Status == "Pending");
    var rejectedCount = leaves.Count(l => l.Status == "Rejected");

    var monthlyCounts = new int[12];
    for (int m = 1; m <= 12; m++)
        monthlyCounts[m - 1] = leaves.Count(l => l.StartDate.Month == m);
}

<div class="dashboard-container">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h2 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h2>
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-report-header me-2" href="@Url.Action("Reports", "Dashboard")">
                <i class="fas fa-chart-line me-2"></i>View Reports
            </a>
            <button class="btn btn-calendar-header" id="openCalendarBtn">
                <i class="fas fa-calendar-alt me-2"></i>Leave Calendar
            </button>
        </div>
    </div>

    <!-- Stats Row (4 Cards) -->
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-lg-3">
            <div class="dashboard-card text-center">
                <div class="feature-icon"><i class="fas fa-users"></i></div>
                <h3 class="mb-2">@ViewBag.TotalUsers</h3>
                <p class="text-muted mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="dashboard-card text-center">
                <div class="feature-icon"><i class="fas fa-user-tie"></i></div>
                <h3 class="mb-2">@ViewBag.TotalManagers</h3>
                <p class="text-muted mb-0">Managers</p>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="dashboard-card text-center">
                <div class="feature-icon"><i class="fas fa-calendar-check"></i></div>
                <h3 class="mb-2">@ViewBag.TotalLeaveRequests</h3>
                <p class="text-muted mb-0">Leave Requests</p>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="dashboard-card text-center">
                <div class="feature-icon"><i class="fas fa-hourglass-half"></i></div>
                <h3 class="mb-2">@ViewBag.PendingApprovals</h3>
                <p class="text-muted mb-0">Pending Approvals</p>
            </div>
        </div>
    </div>

    <!-- Action Buttons Row (5 Buttons in 2 rows) -->
    <div class="row g-3 mb-5">
        <!-- First Row - 3 buttons -->
        <div class="col-md-4">
            <button class="btn btn-action w-100" data-bs-toggle="collapse" data-bs-target="#usersSection">
                <i class="fas fa-users me-2"></i>Manage Users
            </button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-action w-100" data-bs-toggle="collapse" data-bs-target="#departmentsSection">
                <i class="fas fa-building me-2"></i>Manage Departments
            </button>
        </div>
        <div class="col-md-4">
            <a class="btn btn-action w-100" href="@Url.Action("LeavePolicies", "Dashboard")">
                <i class="fas fa-file-contract me-2"></i>Leave Policies
                <span class="badge bg-info ms-2">@ViewBag.TotalLeaveTypes</span>
            </a>
        </div>
        <!-- Second Row - 2 buttons -->
        <div class="col-md-6">
            <a class="btn btn-action w-100" href="@Url.Action("ManagerLeaveRequests", "Dashboard")">
                <i class="fas fa-user-tie me-2"></i>Manager Leaves
                @if (ViewBag.PendingManagerLeaves > 0)
                {
                    <span class="badge bg-danger ms-2">@ViewBag.PendingManagerLeaves</span>
                }
            </a>
        </div>
        <div class="col-md-6">
            <a class="btn btn-action w-100" href="@Url.Action("AllLeaveRequests", "Dashboard")">
                <i class="fas fa-list-alt me-2"></i>All Leaves
                <span class="badge bg-primary ms-2">@ViewBag.TotalLeaveRequests</span>
            </a>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="section-card">
                <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Leave Status Summary</h5>
                <canvas id="leaveStatusChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="section-card">
                <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Monthly Leave Requests</h5>
                <canvas id="monthlyLeaveChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content login-modal">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>Leave Calendar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <select class="form-control" id="departmentFilter">
                                <option value="">All Departments</option>
                                @foreach (var dept in departments)
                                {
                                    <option value="@dept.DepartmentId">@dept.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="Approved">Approved</option>
                                <option value="Pending">Pending</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" id="refreshCalendar">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Calendar
                            </button>
                        </div>
                    </div>

                    <div id="calendarLoading" class="text-center p-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading calendar data...</p>
                    </div>

                    <div id="leaveCalendar"></div>

                    <div class="mt-3">
                        <h6>Legend:</h6>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <span class="badge bg-success p-2 w-100">Approved</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="badge bg-warning p-2 w-100">Pending</span>
                            </div>
                            <div class="col-md-4 mb-2">
                                <span class="badge bg-danger p-2 w-100">Rejected</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Section -->
    <div class="collapse" id="usersSection">
        <div class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-users me-2"></i>User Management</h4>
                <a class="btn btn-primary" href="@Url.Action("ManageUser", "Dashboard")">
                    <i class="fas fa-plus me-1"></i>Add User
                </a>
            </div>

            <!-- Custom Search Box -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-list me-2"></i>User List</h5>
                <div class="search-container">
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="userSearch"
                               placeholder="Search users...">
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark-theme" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Manager</th>
                            <th>Joining</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in users)
                        {
                            <tr>
                                <td>@u.UserId</td>
                                <td>@u.FullName</td>
                                <td>@u.Email</td>
                                <td>
                                    <span class="badge @(u.Role == "Admin" ? "bg-danger" : u.Role == "Manager" ? "bg-warning" : "bg-info")">@u.Role</span>
                                </td>
                                <td>@(u.Department?.Name ?? "N/A")</td>
                                <td>@(u.Manager?.FullName ?? "N/A")</td>
                                <td>@u.DateOfJoining.ToString("dd-MMM-yyyy")</td>
                                <td>
                                    <span class="badge @(u.IsActive ? "bg-success" : "bg-secondary")">@((u.IsActive) ? "Active" : "Inactive")</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a class="btn btn-warning" href="@Url.Action("ManageUser", "Dashboard", new { id = u.UserId })" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        @if (u.Role == "Admin")
                                        {
                                            <a class="btn @(u.IsActive ? "btn-secondary" : "btn-success")"
                                               href="@Url.Action("ToggleAdminStatus", "Dashboard", new { id = u.UserId })"
                                               title="@(u.IsActive ? "Deactivate" : "Activate")"
                                               onclick="return confirm('Are you sure you want to @(u.IsActive ? "deactivate" : "activate") this admin?')">
                                                <i class="fas @(u.IsActive ? "fa-user-slash" : "fa-user-check")"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="btn btn-danger"
                                               href="@Url.Action("DeleteUser", "Dashboard", new { id = u.UserId })"
                                               onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')"
                                               title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Departments Section -->
    <div class="collapse" id="departmentsSection">
        <div class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-building me-2"></i>Department Management</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
                    <i class="fas fa-plus me-1"></i>Add Department
                </button>
            </div>

            <!-- Custom Search Box -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-list me-2"></i>Department List</h5>
                <div class="search-container">
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="departmentSearch"
                               placeholder="Search departments...">
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark-theme" id="departmentsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Employees</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in departments)
                        {
                            <tr>
                                <td>@d.DepartmentId</td>
                                <td>@d.Name</td>
                                <td>@users.Count(u => u.DepartmentId == d.DepartmentId)</td>
                                <td>
                                    <form method="post" asp-action="DeleteDepartment" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@d.DepartmentId" />
                                        <button type="submit" class="btn btn-danger btn-sm"
                                                onclick="return confirm('Are you sure you want to delete this department? All employees will be moved to no department.')"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Leaves Section -->
    <div class="collapse" id="recentLeavesSection">
        <div class="section-card">
            <h4 class="mb-3"><i class="fas fa-list me-2"></i>Recent Leave Applications</h4>
            <div class="table-responsive">
                <table class="table table-dark-theme table-striped">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Leave Type</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Days</th>
                            <th>Status</th>
                            <th>Applied On</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var leave in leaves.Take(10))
                        {
                            <tr>
                                <td>@leave.User?.FullName</td>
                                <td>@leave.LeaveType?.Name</td>
                                <td>@leave.StartDate.ToString("dd-MMM-yyyy")</td>
                                <td>@leave.EndDate.ToString("dd-MMM-yyyy")</td>
                                <td>@((leave.EndDate - leave.StartDate).Days + 1)</td>
                                <td>
                                    <span class="badge @(leave.Status == "Approved" ? "bg-success" : leave.Status == "Pending" ? "bg-warning" : "bg-danger")">
                                        @leave.Status
                                    </span>
                                </td>
                                <td>@leave.AppliedOn.ToString("dd-MMM-yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content login-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title">Add New Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" asp-action="CreateDepartment">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">Department Name</label>
                        <input type="text" class="form-control" name="Name" placeholder="Enter department name" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus me-2"></i>Add Department
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        padding: 20px;
        background: var(--dark-surface);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        margin: 20px 0;
    }

    /* Header Buttons */
    .btn-calendar-header {
        background: var(--primary-accent);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
    }

        .btn-calendar-header:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

    .btn-report-header {
        background: #8b5cf6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
    }

        .btn-report-header:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            color: white;
            text-decoration: none;
        }

    /* Dashboard Cards */
    .dashboard-card {
        background: var(--darker-surface);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1.5rem;
        transition: all 0.3s;
        height: 100%;
    }

        .dashboard-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary-accent);
        }

        .dashboard-card .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-accent);
            margin-bottom: 1rem;
        }

    /* Action Buttons */
    .btn-action {
        background: var(--darker-surface);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s;
    }

        .btn-action:hover, .btn-action[aria-expanded="true"] {
            background: var(--primary-accent);
            color: white;
            border-color: var(--primary-accent);
            transform: translateY(-2px);
        }

    /* Section Cards */
    .section-card {
        background: var(--darker-surface);
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Table Styles */
    .table-dark-theme {
        background: var(--darker-surface);
        color: var(--text-light);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

        .table-dark-theme thead th {
            background: var(--primary-accent);
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px;
        }

        .table-dark-theme tbody tr {
            border-bottom: 1px solid var(--border-color);
        }

            .table-dark-theme tbody tr:hover {
                background: rgba(59, 130, 246, 0.1);
            }

        .table-dark-theme td {
            border-color: var(--border-color);
            vertical-align: middle;
            padding: 12px 15px;
        }

    /* Badges */
    .badge {
        font-size: 0.8rem;
        padding: 6px 12px;
        font-weight: 500;
        border-radius: 20px;
    }

    /* Search Box */
    .search-container .input-group {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

        .search-container .input-group:focus-within {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

    .search-container .input-group-text {
        background: var(--darker-surface);
        border: none;
        color: var(--text-muted);
    }

    .search-container .form-control {
        background: var(--darker-surface);
        border: none;
        box-shadow: none;
        color: var(--text-light);
    }

    /* Hide DataTable Controls */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate,
    .dataTables_wrapper .dataTables_filter {
        display: none !important;
    }

    /* Calendar Styles */
    #leaveCalendar {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
        min-height: 500px !important;
    }

    .fc .fc-button {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
        border-radius: 4px !important;
        padding: 6px 12px !important;
        font-weight: 500 !important;
    }

        .fc .fc-button:hover {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
        }

    .fc-toolbar-title {
        color: #1e293b !important;
        font-weight: 600 !important;
        font-size: 1.5rem !important;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }

        .row.align-items-center {
            text-align: center;
        }

        .text-end {
            text-align: center !important;
            margin-top: 10px;
        }

        .search-container .input-group {
            width: 100% !important;
            margin-top: 10px;
        }

        .d-flex.justify-content-between {
            flex-direction: column;
        }
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>
    
    <script>
        // Global variables
        let calendar = null;
        let fullCalendarLoaded = false;

        // Function to check if FullCalendar is loaded
        function checkFullCalendarLoaded() {
            if (typeof FullCalendar === 'undefined') {
                console.error('FullCalendar not loaded!');
                loadFullCalendarDynamically();
                return false;
            }
            return true;
        }

        // Dynamically load FullCalendar if not loaded
        function loadFullCalendarDynamically() {
            if (fullCalendarLoaded) return;
            
            console.log('Dynamically loading FullCalendar...');
            
            // Load CSS
            const cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css';
            document.head.appendChild(cssLink);
            
            // Load JS
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js';
            script.onload = function() {
                fullCalendarLoaded = true;
                console.log('FullCalendar loaded successfully');
            };
            script.onerror = function() {
                console.error('Failed to load FullCalendar');
                showCalendarError();
            };
            document.head.appendChild(script);
        }

        // Show calendar error
        function showCalendarError() {
            const calendarEl = document.getElementById('leaveCalendar');
            if (calendarEl) {
                calendarEl.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Calendar Error</h4>
                        <p>Failed to load calendar library. Please check your internet connection.</p>
                        <button class="btn btn-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-redo me-2"></i>Reload Page
                        </button>
                    </div>
                `;
            }
        }

        // Initialize calendar with REAL DATABASE DATA
        function initializeCalendar() {
            console.log('Initializing calendar...');
            
            if (!checkFullCalendarLoaded()) {
                setTimeout(initializeCalendar, 1000); // Try again in 1 second
                return;
            }

            const calendarEl = document.getElementById('leaveCalendar');
            const loadingEl = document.getElementById('calendarLoading');
            
            if (!calendarEl) {
                console.error('Calendar element not found');
                return;
            }

            // Show loading
            if (loadingEl) loadingEl.style.display = 'block';
            calendarEl.innerHTML = '';

            // Get filter values
            const departmentId = $('#departmentFilter').val() || '';
            const status = $('#statusFilter').val() || 'all';

            console.log('Fetching calendar data with filters:', { departmentId, status });

            // AJAX call to get REAL DATA from database
            $.ajax({
                url: '/Dashboard/GetLeavesForCalendar',
                type: 'GET',
                data: {
                    departmentId: departmentId,
                    status: status
                },
                success: function(events) {
                    console.log('✅ Database data loaded successfully:', events);
                    
                    if (loadingEl) loadingEl.style.display = 'none';
                    
                    if (!events || events.length === 0) {
                        calendarEl.innerHTML = `
                            <div class="alert alert-info">
                                <h5>No Leave Data Found</h5>
                                <p>No leave requests match the selected filters.</p>
                                <p>Try changing the department or status filter.</p>
                            </div>
                        `;
                        return;
                    }

                    try {
                        // Destroy previous calendar instance
                        if (calendar) {
                            calendar.destroy();
                        }

                        // Create new calendar
                        calendar = new FullCalendar.Calendar(calendarEl, {
                            themeSystem: 'bootstrap5',
                            initialView: 'dayGridMonth',
                            height: 550,
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,timeGridDay'
                            },
                            buttonText: {
                                today: 'Today',
                                month: 'Month',
                                week: 'Week',
                                day: 'Day'
                            },
                            dayMaxEvents: 3,
                            events: events,
                            eventClick: function(info) {
                                const event = info.event;
                                const props = event.extendedProps;
                                
                                Swal.fire({
                                    title: 'Leave Details',
                                    html: `
                                        <div class="text-start">
                                            <p><strong>Employee:</strong> ${props.employee || 'N/A'}</p>
                                            <p><strong>Leave Type:</strong> ${props.leaveType || 'N/A'}</p>
                                            <p><strong>Status:</strong> 
                                                <span class="badge ${props.status === 'Approved' ? 'bg-success' : 
                                                    props.status === 'Rejected' ? 'bg-danger' : 'bg-warning'}">
                                                    ${props.status || 'N/A'}
                                                </span>
                                            </p>
                                            <p><strong>Department:</strong> ${props.department || 'N/A'}</p>
                                            <p><strong>From:</strong> ${new Date(event.start).toLocaleDateString()}</p>
                                            <p><strong>To:</strong> ${event.end ? new Date(new Date(event.end).setDate(new Date(event.end).getDate() - 1)).toLocaleDateString() : 'Same day'}</p>
                                            <p><strong>Days:</strong> ${props.days || '1'}</p>
                                            <p><strong>Reason:</strong> ${props.reason || 'No reason provided'}</p>
                                            <p><strong>Applied On:</strong> ${props.appliedOn || 'N/A'}</p>
                                            <p><strong>Comments:</strong> ${props.comments || 'No comments'}</p>
                                        </div>
                                    `,
                                    icon: 'info',
                                    confirmButtonColor: '#3b82f6',
                                    width: '600px'
                                });
                            },
                            eventDidMount: function(info) {
                                // Add tooltip
                                const props = info.event.extendedProps;
                                info.el.title = `${props.employee} - ${props.leaveType} (${props.status})`;
                            }
                        });

                        calendar.render();
                        console.log('✅ Calendar initialized successfully!');
                        
                    } catch (error) {
                        console.error('Calendar creation error:', error);
                        calendarEl.innerHTML = `
                            <div class="alert alert-danger">
                                <h4>Calendar Error</h4>
                                <p>${error.message}</p>
                                <button class="btn btn-primary mt-2" onclick="initializeCalendar()">
                                    <i class="fas fa-redo me-2"></i>Try Again
                                </button>
                            </div>
                        `;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error loading calendar data:', error);
                    if (loadingEl) loadingEl.style.display = 'none';
                    
                    // Fallback: Use data from ViewBag
                    useFallbackData();
                }
            });
        }

        // Fallback: Use ViewBag data
        function useFallbackData() {
            const calendarEl = document.getElementById('leaveCalendar');
            if (!calendarEl) return;

            try {
                // Convert leaves from ViewBag to calendar format
                const viewBagLeaves = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                    leaves.Select(l => new {
                        id = l.LeaveId,
                        title = $"{l.User?.FullName} - {l.LeaveType?.Name} ({l.Status})",
                        start = l.StartDate.ToString("yyyy-MM-dd"),
                        end = l.EndDate.AddDays(1).ToString("yyyy-MM-dd"),
                        backgroundColor = l.Status == "Approved" ? "#22c55e" : 
                                       l.Status == "Rejected" ? "#ef4444" : "#f59e0b",
                        borderColor = l.Status == "Approved" ? "#22c55e" : 
                                    l.Status == "Rejected" ? "#ef4444" : "#f59e0b",
                        textColor = "#ffffff",
                        allDay = true,
                        extendedProps = new {
                            employee = l.User?.FullName,
                            leaveType = l.LeaveType?.Name,
                            status = l.Status,
                            department = l.User?.Department?.Name ?? "No Department",
                            days = (l.EndDate - l.StartDate).Days + 1,
                            reason = l.Reason ?? "No reason provided",
                            appliedOn = l.AppliedOn.ToString("yyyy-MM-dd"),
                            comments = l.ManagerComments ?? "No comments"
                        }
                    })
                ));

                console.log('Using ViewBag data (fallback):', viewBagLeaves);

                // Destroy previous calendar
                if (calendar) {
                    calendar.destroy();
                }

                // Create new calendar
                calendar = new FullCalendar.Calendar(calendarEl, {
                    themeSystem: 'bootstrap5',
                    initialView: 'dayGridMonth',
                    height: 550,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    dayMaxEvents: 3,
                    events: viewBagLeaves,
                    eventClick: function(info) {
                        const event = info.event;
                        const props = event.extendedProps;
                        
                        Swal.fire({
                            title: 'Leave Details',
                            html: `
                                <div class="text-start">
                                    <p><strong>Employee:</strong> ${props.employee || 'N/A'}</p>
                                    <p><strong>Leave Type:</strong> ${props.leaveType || 'N/A'}</p>
                                    <p><strong>Status:</strong> 
                                        <span class="badge ${props.status === 'Approved' ? 'bg-success' : 
                                            props.status === 'Rejected' ? 'bg-danger' : 'bg-warning'}">
                                            ${props.status || 'N/A'}
                                        </span>
                                    </p>
                                    <p><strong>Department:</strong> ${props.department || 'N/A'}</p>
                                    <p><strong>From:</strong> ${new Date(event.start).toLocaleDateString()}</p>
                                    <p><strong>To:</strong> ${event.end ? new Date(new Date(event.end).setDate(new Date(event.end).getDate() - 1)).toLocaleDateString() : 'Same day'}</p>
                                    <p><strong>Days:</strong> ${props.days || '1'}</p>
                                    <p><strong>Reason:</strong> ${props.reason || 'No reason provided'}</p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonColor: '#3b82f6'
                        });
                    }
                });

                calendar.render();
                console.log('✅ Calendar loaded with ViewBag data!');
                
            } catch (error) {
                console.error('Fallback error:', error);
                calendarEl.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>Unable to Load Calendar</h4>
                        <p>Could not load calendar data. Please try again later.</p>
                        <button class="btn btn-primary mt-2" onclick="initializeCalendar()">
                            <i class="fas fa-redo me-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        }

        // Document ready
        $(document).ready(function() {
            console.log('Admin page loaded');

          // Initialize Users Table WITHOUT any controls (like MyLeaves.cshtml)
const usersTable = $('#usersTable').DataTable({
    pageLength: 1000, // Show all rows
    order: [[0, 'desc']], // Sort by ID descending
    responsive: true,
    searching: true, // Enable searching
    paging: false, // Disable pagination
    info: false, // Hide "Showing X of Y entries"
    lengthMenu: false, // Hide "Show X entries"
    columnDefs: [
        { orderable: false, targets: [8] } // Disable sorting for Actions column
    ],
    language: {
        search: "", // Empty string to remove search label
        emptyTable: "No users found"
    },
    // Remove all DataTable controls
    dom: 't'
});

// Initialize Departments Table WITHOUT any controls (like MyLeaves.cshtml)
const departmentsTable = $('#departmentsTable').DataTable({
    pageLength: 1000, // Show all rows
    order: [[0, 'desc']], // Sort by ID descending
    responsive: true,
    searching: true, // Enable searching
    paging: false, // Disable pagination
    info: false, // Hide "Showing X of Y entries"
    lengthMenu: false, // Hide "Show X entries"
    columnDefs: [
        { orderable: false, targets: [3] } // Disable sorting for Actions column
    ],
    language: {
        search: "", // Empty string to remove search label
        emptyTable: "No departments found"
    },
    // Remove all DataTable controls
    dom: 't'
});

// Custom search for Users table
$('#userSearch').on('keyup', function() {
    usersTable.search(this.value).draw();
});

// Custom search for Departments table
$('#departmentSearch').on('keyup', function() {
    departmentsTable.search(this.value).draw();
});
            // Initialize charts
            var ctxStatus = document.getElementById('leaveStatusChart');
            if (ctxStatus) {
                new Chart(ctxStatus.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Approved', 'Pending', 'Rejected'],
                        datasets: [{
                            data: [@approvedCount, @pendingCount, @rejectedCount],
                            backgroundColor: ['#22c55e', '#facc15', '#ef4444'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#f1f5f9'
                                }
                            }
                        }
                    }
                });
            }

            var ctxMonthly = document.getElementById('monthlyLeaveChart');
            if (ctxMonthly) {
                var monthlyData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(monthlyCounts));
                new Chart(ctxMonthly.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
                        datasets: [{
                            label: 'Leave Requests',
                            data: monthlyData,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#f1f5f9'
                                },
                                grid: {
                                    color: '#334155'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#f1f5f9'
                                },
                                grid: {
                                    color: '#334155'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#f1f5f9'
                                }
                            }
                        }
                    }
                });
            }

            // Calendar button click
            $('#openCalendarBtn').click(function() {
                $('#calendarModal').modal('show');
            });

            // Initialize calendar when modal opens
            $('#calendarModal').on('shown.bs.modal', function() {
                console.log('Calendar modal opened');
                setTimeout(initializeCalendar, 300);
            });

            // Refresh button
            $('#refreshCalendar').click(function() {
                console.log('Refreshing calendar...');
                initializeCalendar();
            });

            // Filter changes
            $('#departmentFilter, #statusFilter').change(function() {
                console.log('Filter changed, reloading calendar...');
                initializeCalendar();
            });

            // Check FullCalendar on page load
            checkFullCalendarLoaded();
        });
    </script>
}
