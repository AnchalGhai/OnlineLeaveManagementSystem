@using System.Security.Claims
@model List<LeaveManagementSystem.Models.Entities.User>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Team Members";

    var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var userId = userIdClaim != null ? int.Parse(userIdClaim) : 0;
    var teamMemberDetails = ViewBag.TeamMemberDetails as List<LeaveManagementSystem.Controllers.ManagerDashboardController.TeamMemberDetail>;
}

<div class="dashboard-container">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h2 class="mb-0"><i class="fas fa-users me-2"></i>Team Members</h2>
            <p class="text-muted mb-0">Manage your team members and their leave details</p>
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-secondary" href="@Url.Action("Index", "ManagerDashboard")">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <i class="fas fa-users-slash fa-4x text-muted mb-4"></i>
            <h4>No Team Members Assigned</h4>
            <p class="text-muted">No employees are currently assigned to your team.</p>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="section-card">
                    <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Team Summary</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                <h3 class="mb-1">@Model.Count</h3>
                                <p class="mb-0 text-muted">Total Members</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                <h3 class="mb-1">@Model.Count(m => m.DateOfJoining.Year == DateTime.Now.Year)</h3>
                                <p class="mb-0 text-muted">Joined This Year</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var member in Model)
            {
                var memberDetail = teamMemberDetails?.FirstOrDefault(t => t.User.UserId == member.UserId);

                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="section-card h-100">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-circle-lg bg-primary me-3">
                                @member.FullName[0]
                            </div>
                            <div>
                                <h5 class="mb-1">@member.FullName</h5>
                                <div class="small text-muted">
                                    <i class="fas fa-envelope me-1"></i>@member.Email
                                </div>
                                <div class="small text-muted">
                                    <i class="fas fa-building me-1"></i>@member.Department?.Name
                                </div>
                            </div>
                        </div>

                        <!-- Leave Balances -->
                        <div class="mb-3">
                            <h6><i class="fas fa-calendar-alt me-2"></i>Leave Balances</h6>
                            <div class="row g-2">
                                @if (memberDetail?.LeaveBalances != null)
                                {
                                    @foreach (var balance in memberDetail.LeaveBalances.Take(3))
                                    {
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center small">
                                                <span>@balance.LeaveType?.Name</span>
                                                <span>
                                                    <span class="badge bg-success">@balance.Remaining</span>
                                                    <span class="text-muted">/ @balance.TotalAssigned</span>
                                                </span>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="col-12">
                                        <p class="small text-muted mb-0">No leave balances found</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                                        <div class="small text-muted">Pending</div>
                                        <div class="fw-bold">@(memberDetail?.PendingRequests ?? 0)</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-info bg-opacity-10 rounded">
                                        <div class="small text-muted">Joined</div>
                                        <div class="fw-bold">@member.DateOfJoining.ToString("MMM yyyy")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Detailed Table View -->
        <div class="section-card mt-4">
            <h5 class="mb-3"><i class="fas fa-table me-2"></i>Detailed Team Information</h5>
            <div class="table-responsive">
                <table class="table table-dark-theme">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Joining Date</th>
                            <th>Status</th>
                            <th>Email</th>
                            <th>Leave Balance</th>
                            <!-- Actions column removed -->
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var member in Model)
                        {
                            var memberDetail = teamMemberDetails?.FirstOrDefault(t => t.User.UserId == member.UserId);
                            var totalRemaining = memberDetail?.LeaveBalances?.Sum(b => b.Remaining) ?? 0;
                            var totalAssigned = memberDetail?.LeaveBalances?.Sum(b => b.TotalAssigned) ?? 0;

                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle-sm bg-primary me-2">
                                            @member.FullName[0]
                                        </div>
                                        <div>
                                            <div class="fw-medium">@member.FullName</div>
                                            <small class="text-muted">ID: @member.UserId</small>
                                        </div>
                                    </div>
                                </td>
                                <td>@member.Department?.Name</td>
                                <td>@member.DateOfJoining.ToString("dd-MMM-yyyy")</td>
                                <td>
                                    <span class="badge @(member.IsActive ? "bg-success" : "bg-secondary")">
                                        @(member.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>@member.Email</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        @if (totalAssigned > 0)
                                        {
                                            var percentage = (totalRemaining * 100) / totalAssigned;
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 style="width: @percentage%"
                                                 aria-valuenow="@totalRemaining"
                                                 aria-valuemin="0"
                                                 aria-valuemax="@totalAssigned">
                                                @totalRemaining / @totalAssigned
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="progress-bar bg-secondary" style="width: 100%">No Data</div>
                                        }
                                    </div>
                                </td>
                                <!-- Actions cells removed -->
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<style>
    .dashboard-container {
        padding: 20px;
    }

    .section-card {
        background: var(--dark-surface);
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: transform 0.3s;
    }

        .section-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-accent);
        }

    .avatar-circle-lg {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.5rem;
        background: var(--primary-accent);
    }

    .avatar-circle-sm {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        background: var(--primary-accent);
    }

    .table-dark-theme {
        background: var(--dark-surface);
        color: var(--text-light);
        border-radius: 8px;
        overflow: hidden;
    }

        .table-dark-theme thead th {
            background: var(--darker-surface);
            color: var(--text-light);
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            font-weight: 600;
        }

        .table-dark-theme tbody tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

    .progress {
        background-color: var(--border-color);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        font-size: 12px;
        font-weight: 600;
    }

    .btn-group .btn {
        border-radius: 6px;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-dismiss alerts
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        });
    </script>
}